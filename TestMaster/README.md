# TestMaster (SignalR сервер и мастер-хранилище)

## Назначение
TestMaster — это серверная часть, поднимающая SignalR-хаб `MasterHub` и управляющая мастер-базой данных (SQLite). Он:
- хранит эталонные данные (`Items`);
- принимает изменения от клиентов и рассылает актуальные снимки всем подключенным клиентам;
- обрабатывает исходящие сообщения (паттерн Outbox) и обеспечивает доставку при восстановлении соединения.

## Архитектура

- Хостинг и транспорт:
  - OWIN self-host на `http://localhost:8080`.
  - SignalR (ASP.NET, 2.4.3) со схемой:
    - Браузерная проверка: `GET /` (информационная страница «Server now work on port 8080»).
    - Хаб: `MasterHub` (внутренний класс), маршрутизируется через `/signalr`.
- Слои:
  - `Services/MasterHub`: SignalR-хаб, методы: 
    - `GetAllItems()` — получить полный набор данных;
    - `PushClientChanges(List<Item>)` — принять изменения от клиента, обновить мастер и разослать всем;
    - `MasterUpdate(Item)` — зафиксировать изменение от мастера, разослать всем;
    - `ForceSync()` — разослать текущие данные всем клиентам;
    - `NotifyClientsOfMasterChanges()` — служебный метод явного уведомления.
  - `Services/SyncService` — доменная логика синхронизации (работает с `IItemRepository`, `IOutboxRepository`).
  - `Repositories/*` — доступ к данным (EF6 SQLite).
  - `Services/OutboxProcessor` — фоновая обработка исходящих сообщений (outbox), обеспечивает гарантированную доставку.
  - `DependencyInjection/ServiceRegister` — регистрация сервисов в DI.
  - `Services/SignalRHostedService` — запуск OWIN + SignalR (с CORS и DI-резолвером).
- Данные:
  - SQLite-файл: `TestMaster.db`.
  - Таблицы: `Items`, `OutboxMessages`.
  - Конфигурации сущностей — `DataAccess/*Configuration.cs`, регистрируются через `ModelBuilderExtensions.RegisterConfigurations()`.

## Потоки данных
- Клиент подключается к `MasterHub`.
- Клиент вызывает `GetAllItems()` — получает полный список.
- Клиент отправляет изменения через `PushClientChanges` — мастер сохраняет и рассылает всем свежий снимок.
- При изменениях на мастере (команды в консоли) вызывается `MasterUpdate`/`ForceSync` — клиенты получают обновления в реальном времени.
- При недоступности клиентов изменения попадают в `OutboxMessages` → `OutboxProcessor` периодически пытается доставить.

## Компоненты и зависимости
- .NET Framework 4.6.1
- NuGet:
  - Microsoft.AspNet.SignalR 2.4.3
  - Microsoft.Owin, Microsoft.Owin.Hosting, Microsoft.Owin.Cors
  - EntityFramework 6.5.1
  - System.Data.SQLite (EF6)
- Конфигурация: `App.config`
  - Connection string: `DefaultConnection` → SQLite файл `TestMaster.db`.

## Запуск
1. Соберите решение.
2. Запустите проект TestMaster.
3. Убедитесь, что:
   - Консоль пишет: «SignalR сервер запущен на http://localhost:8080».
   - В браузере `http://localhost:8080` открывается страница статуса.
   - Хаб доступен по пути `/signalr` (SignalR клиент сам согласует транспорт).

## Консольные команды TestMaster
- `1` — Показать все элементы.
- `2` — Добавить элемент.
- `3` — Обновить элемент.
- `4` — Удалить элемент.
- `5` — Принудительная синхронизация с клиентами.
- `q` — Выход (корректная остановка SignalR и `OutboxProcessor`).

## Тестовые сценарии

### Мастер отдельно
1) Создайте, обновите, удалите элементы (2/3/4), проверяйте «1».
2) Запустите `5` — уходит широковещательное сообщение (увидите лог).
3) Проверьте, что запись/чтение идут из `TestMaster.db`.

### Мастер + несколько клиентов
1) Запустите TestMaster (увидите хаб и статус).
2) Запустите один или несколько TestClient.
3) Из мастера создайте/обновите/удалите элементы — клиенты увидят обновления.
4) Остановите мастера, сделайте изменения у клиентов (они уйдут в outbox). Поднимите мастера — `OutboxProcessor` обработает накопившееся.

## Траблшутинг

- Ошибка 500 при подключении клиента:
  - Проверьте, что TestMaster запущен и порт 8080 свободен.
  - Убедитесь, что клиент подключается к базовому `http://localhost:8080` (без ручного добавления `/signalr` в клиентском URL).
- «Unknown transport» в браузере на `/signalr`:
  - Это нормальное поведение при прямом заходе в транспортный endpoint. Клиент SignalR сам согласует транспорт.
- `SQLite error (1): no such table: OutboxMessages`:
  - Удалите файл БД (`bin\Debug\TestMaster.db`) и запустите заново — БД пересоздастся с актуальной моделью.
  - Убедитесь, что `MasterDbContext` регистрирует конфигурации и инициализируется до старта `OutboxProcessor`.
- Нет оповещений клиентов:
  - Проверьте логи `MasterHub` при вызовах `MasterUpdate`/`PushClientChanges`/`ForceSync`.
  - Убедитесь, что версии Microsoft.AspNet.SignalR на сервере и клиенте — 2.4.3.