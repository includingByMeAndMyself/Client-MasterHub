# TestClient (SignalR клиент и локальное хранилище)

## Назначение
TestClient — клиентское приложение, которое:
- подключается к `MasterHub` на мастере (SignalR);
- получает полный снимок данных и обновления в реальном времени;
- хранит данные локально (SQLite), работает офлайн;
- при восстановлении связи синхронизирует накопленные изменения (через outbox и стратегию разрешения конфликтов).

## Архитектура

- Транспорт:
  - SignalR client (Microsoft.AspNet.SignalR.Client 2.4.3).
  - Подключение к базовому URL мастера: значение ключа `ServerUrl` (например, `http://localhost:8080`). Сам клиент согласует путь `/signalr`.
- Слои:
  - `Proxies/ServerHubProxy` — обертка над SignalR-клиентом:
    - Подключение/отключение, события подключения/отключения.
    - Вызывание методов хаба: `GetAllItems`, `PushClientChanges`.
    - Подписка на `ReceiveServerUpdate`.
  - `Services/SyncManager` — оркестратор синхронизации:
    - Периодическая синхронизация по таймеру (`SyncInterval`).
    - Автопереподключение по таймеру (`ReconnectInterval`).
    - Применение `IConflictResolutionStrategy` (по умолчанию `LastWriteWinsStrategy`).
    - Обработка исходящих сообщений `OutboxRepository`.
  - `Repositories/*` — локальная БД (EF6 SQLite).
  - `Strategies/*` — стратегии разрешения конфликтов.
  - `DependencyInjection/ServiceRegister` — DI-конфигурация.

## Оффлайн и синхронизация
- Если соединение потеряно:
  - изменения пользователя сохраняются в локальную БД;
  - исходящие сообщения складываются в Outbox;
  - при восстановлении связи `SyncManager`:
    - подгружает свежие данные с мастера;
    - применяет стратегию конфликтов;
    - отправляет накопленные изменения на мастер;
    - очищает обработанные сообщения.

## Конфигурация (App.config)
```xml
<appSettings>
  <add key="ServerUrl" value="http://localhost:8080" />
  <add key="ReconnectInterval" value="5000" />
  <add key="SyncInterval" value="10000" />
</appSettings>
```
- `ServerUrl` — базовый URL мастера (без явного `/signalr`).
- `ReconnectInterval` — период автопереподключения (мс).
- `SyncInterval` — период фоновой синхронизации (мс).

## Команды в консоли клиента
- `1` — Показать все элементы (из локальной БД).
- `2` — Добавить элемент (сохраняется локально; outbox сформирует исходящее сообщение).
- `3` — Обновить элемент.
- `4` — Удалить элемент.
- `5` — Принудительная синхронизация (если подключены).
- `q` — Выход (корректная остановка синхронизации).

Примечание: текущее поведение — автопереподключение включено и управляется таймером `ReconnectInterval`. Если нужна ручная команда переподключения/переключатель автопереподключения — это можно добавить в `ISyncManager`/`Program` (см. идеи в истории изменений).

## Запуск
1. Убедитесь, что запущен TestMaster (и доступна страница `http://localhost:8080`).
2. Запустите TestClient.
3. В логах клиента увидите:
   - «Попытка подключения к серверу: …»
   - «Изменение состояния подключения: …»
   - «Подключение к серверу установлено».

## Типовой сценарий работы (мастер + клиент)
1) Запускаете TestMaster, затем TestClient.
2) На мастере создаете элементы — клиент получает обновления в реальном времени.
3) На клиенте в оффлайне создаете/меняете элементы — они сохраняются локально.
4) При восстановлении связи:
   - клиент запрашивает полный снимок у мастера;
   - разрешает конфликты (`LastWriteWins`);
   - отправляет локальные изменения на мастер;
   - отображает итоговые данные.

## Тестовые сценарии

### Клиент отдельно
1) Запустите только TestClient (мастер не запущен).
2) Выполните `2/3/4`, затем `1` — видите локальные изменения (оффлайн).
3) В логах — сообщения о пропуске синхронизации и попытках автопереподключения.

### Связка мастер–клиент
1) Запустите TestMaster, затем TestClient.
2) На мастере: `2` (добавить), на клиенте: `1` — элемент появился.
3) На клиенте: `2/3/4`, затем `5` — изменения уходят на мастер (и разносятся всем).

### Потеря связи
1) Запустите обоих.
2) Остановите мастера, сделайте изменения на клиенте (копятся в outbox).
3) Поднимите мастера — через автопереподключение клиент синхронизируется, outbox очистится.

### Конфликты
1) Обновите один и тот же элемент на мастере и клиенте с разными `LastModified`.
2) При синхронизации победит запись с более поздним `LastModified` (Last-Write-Wins).

## Траблшутинг

- «Сервер не подключен, пропускаем синхронизацию»:
  - Проверьте, что TestMaster запущен, порт 8080 свободен.
  - Убедитесь, что `ServerUrl` указывает на `http://localhost:8080`.
- Ошибка 500 (Internal Server Error) при подключении:
  - Проверьте логи TestMaster.
  - Убедитесь, что клиент подключается к базовому URL (без ручного `/signalr`).
- «Unknown transport» при открытии `/signalr` в браузере:
  - Это нормальная реакция — браузер без клиента SignalR не согласует транспорт. Клиентское подключение корректно через базовый URL.
- Нет локальных обновлений:
  - Проверьте логи `SyncManager` и `ServerHubProxy`.
  - Убедитесь, что версии SignalR сервер/клиент — 2.4.3.

## Зависимости
- .NET Framework 4.6.1
- Microsoft.AspNet.SignalR.Client 2.4.3
- EntityFramework 6.5.1
- System.Data.SQLite (EF6)